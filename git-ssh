#!/usr/bin/env bash

_usage () {
  echo "usage: git ssh <remote>"
  echo "   or: git ssh <remote> [-t] <command>"
  exit 1
}

# TODO: add support for git+ssh://
# TODO: add support for ssh://
_getRemoteHost () {
  git config remote."$1".url | cut -d: -f1
}

_getRemoteDirectory () {
  git config remote."$1".url | cut -d: -f2
}

_sshcd () {
  ssh "$(_getRemoteHost "$remote")" $ssh_opts $ssh_tty "cd '"$(_getRemoteDirectory "$remote")"' && $@"
  exit $?
}

case $1 in
  ''|h|help|\?|-h|--help)
    _usage
    ;;
  *)
    remote="$1"
    shift
    ;;
esac

ssh_opts=""
ssh_tty=""
while true
do
  case $1 in
    -1|-2|-4|-6|-A|-a|-C|-f|-g|-K|-k|-M|-N|-n|-q|-s|-V|-v|-X|-x|-Y|-y)
      ssh_opts="$ssh_opts $1"
      shift
      ;;
    -b|-c|-D|-e|-F|-I|-i|-L|-l|-m|-O|-o|-p|-R|-S|-W|-w)
      ssh_opts="$ssh_opts $1 $2"
      shift
      shift
      ;;
    -t|-T)
      ssh_tty="$1"
      shift
      ;;
    '')
      ssh_tty=${ssh_tty:--t}
      _sshcd "exec "'${SHELL:-/bin/bash}'
      ;;
    *)
      _sshcd "$@"
      ;;
  esac
done
